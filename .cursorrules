# Personal Assistant - Quick Reference

**⚠️ Legacy Format**: This file is legacy but still supported. See `.cursor/rules/` for the primary rule system.

Quick index only - detailed patterns are in `.cursor/rules/*.mdc`.

## Core Principles

- **Local-first**: No cloud dependencies, works offline
- **Security**: Fail-closed, deny by default, path validation required
- **Validation**: Zod schemas everywhere, runtime validation at boundaries
- **Errors**: Structured errors with `makeError()`, never throw
- **Testing**: Colocated test files (`*.test.ts`), custom test runner

## Quick Patterns

### Tools
- Return `ToolResult` with `{ ok: true, result }` or `{ ok: false, error }`
- Use `makeError(code, message)` for errors
- Validate args with Zod schemas
- Use `context.paths.resolveAllowed()` for file paths

### Imports
1. Node built-ins: `import * as fs from 'node:fs'`
2. External packages: `import { z } from 'zod'`
3. Internal: Relative paths only, no `@repo/*` aliases

### Types
- Derive from Zod: `type Args = z.infer<typeof Schema>`
- Use discriminated unions for results
- Type guards for runtime checks

### Async
- Always `async/await`, never raw Promises
- Try/catch for error handling
- Return structured errors, don't throw

### Files
- Source: `snake_case.ts`
- Tests: `*.test.ts` colocated
- Index: `index.ts` for barrel exports

## Common Tasks

### Add New Tool
1. Schema in `src/core/types.ts` (Zod)
2. Handler in `src/tools/*.ts` (returns ToolResult)
3. Register in `src/core/tool_registry.ts`
4. Add to agent in `src/agents/index.ts`
5. Test in `src/tools/*.test.ts`

### Add Error Handling
- Find `throw` statements
- Convert to `return { ok: false, error: makeError(...) }`
- Add try/catch where needed
- See `.cursor/rules/errors.mdc` for patterns

### Add Tests
- Create `*.test.ts` next to source
- Use `createMockContext()` from test utils
- Test success, error, and edge cases
- See `.cursor/rules/testing.mdc` for patterns

## Architecture

```
src/
├── app/         # CLI, REPL, router, web server
├── core/        # Config, executor, types, validation
├── agents/      # Agent definitions (System, Coder, etc.)
├── parsers/     # Heuristic, task, memory parsers
├── providers/   # LLM provider adapters
├── storage/     # JSONL persistence
├── runtime/     # Dependency injection
└── tools/       # Tool implementations
```

## Key Files

- `src/app/cli.ts` - CLI entry point
- `src/app/router.ts` - Intent routing
- `src/core/executor.ts` - Tool execution + security
- `src/core/types.ts` - All type definitions
- `src/tools/schemas.ts` - Tool specifications

## See Also

- `.cursor/rules/core.mdc` - Detailed conventions
- `.cursor/rules/tools.mdc` - Tool implementation patterns
- `.cursor/rules/testing.mdc` - Testing patterns
- `.cursor/rules/errors.mdc` - Error handling patterns
- `.cursor/rules/security.mdc` - Security patterns

