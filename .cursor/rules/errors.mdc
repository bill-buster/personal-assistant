---
description: Error handling patterns and error code conventions
globs: ["**/*.ts"]
alwaysApply: false
---

# Error Handling Patterns

## Error Code System

All errors use structured error codes defined in `src/core/tool_contract.ts`:

```typescript
export enum ErrorCode {
    // Permission Errors (4xx-like)
    DENIED_COMMAND_ALLOWLIST = 'DENIED_COMMAND_ALLOWLIST',
    DENIED_PATH_ALLOWLIST = 'DENIED_PATH_ALLOWLIST',
    DENIED_TOOL_BLOCKLIST = 'DENIED_TOOL_BLOCKLIST',
    DENIED_AGENT_TOOLSET = 'DENIED_AGENT_TOOLSET',
    CONFIRMATION_REQUIRED = 'CONFIRMATION_REQUIRED',
    
    // Validation Errors (4xx-like)
    VALIDATION_ERROR = 'VALIDATION_ERROR',
    INVALID_ARGUMENT = 'INVALID_ARGUMENT',
    MISSING_ARGUMENT = 'MISSING_ARGUMENT',
    UNKNOWN_TOOL = 'UNKNOWN_TOOL',
    
    // Execution Errors (5xx-like)
    EXEC_ERROR = 'EXEC_ERROR',
    TIMEOUT = 'TIMEOUT',
}
```

## Creating Errors

Always use `makeError()` helper:

```typescript
import { makeError } from '../core';

// ✅ Good - Structured error
return {
    ok: false,
    error: makeError('VALIDATION_ERROR', 'Text cannot be empty'),
};

// ❌ Bad - Plain string
return {
    ok: false,
    error: 'Text cannot be empty', // Missing code
};
```

## Error Details

Include helpful details for debugging:

```typescript
// ✅ Good - Includes context
return {
    ok: false,
    error: makeError(
        'DENIED_PATH_ALLOWLIST',
        `Path '${requestedPath}' is not allowed`,
        {
            requested: requestedPath,
            allowed: context.permissions.allow_paths,
            permissionsFile: context.permissionsPath,
        }
    ),
};

// ❌ Bad - Generic message
return {
    ok: false,
    error: makeError('DENIED_PATH_ALLOWLIST', 'Path not allowed'),
};
```

## Never Throw

Tool handlers should never throw - always return errors:

```typescript
// ✅ Good - Return error
export function handleTool(args: Args, context: Context): ToolResult {
    try {
        const result = riskyOperation();
        return { ok: true, result };
    } catch (err: any) {
        return {
            ok: false,
            error: makeError('EXEC_ERROR', err.message),
        };
    }
}

// ❌ Bad - Throws
export function handleTool(args: Args, context: Context): ToolResult {
    const result = riskyOperation(); // May throw
    return { ok: true, result };
}
```

## Error Propagation

Propagate errors with context:

```typescript
// ✅ Good - Preserve context
async function processFile(path: string): Promise<ToolResult> {
    try {
        const content = await readFile(path);
        return processContent(content);
    } catch (err: any) {
        return {
            ok: false,
            error: makeError(
                'EXEC_ERROR',
                `Failed to process file '${path}': ${err.message}`,
                { path, originalError: err.message }
            ),
        };
    }
}

// ❌ Bad - Lose context
async function processFile(path: string): Promise<ToolResult> {
    try {
        const content = await readFile(path);
        return processContent(content);
    } catch (err: any) {
        return {
            ok: false,
            error: makeError('EXEC_ERROR', err.message), // Lost path context
        };
    }
}
```

## Validation Errors

Use specific validation error codes:

```typescript
// ✅ Good - Specific error code
if (!args.text || args.text.trim().length === 0) {
    return {
        ok: false,
        error: makeError('MISSING_ARGUMENT', 'Text is required'),
    };
}

if (args.text.length > MAX_LENGTH) {
    return {
        ok: false,
        error: makeError(
            'INVALID_ARGUMENT',
            `Text exceeds maximum length of ${MAX_LENGTH} characters`
        ),
    };
}

// ❌ Bad - Generic error
if (!args.text) {
    return {
        ok: false,
        error: makeError('VALIDATION_ERROR', 'Invalid input'), // Too generic
    };
}
```

## Permission Errors

Use specific permission error codes:

```typescript
// ✅ Good - Specific permission error
if (!context.agent.tools.includes(toolName)) {
    return {
        ok: false,
        error: makeError(
            'DENIED_AGENT_TOOLSET',
            `Agent '${context.agent.name}' cannot use tool '${toolName}'`
        ),
    };
}

// ❌ Bad - Generic error
if (!context.agent.tools.includes(toolName)) {
    return {
        ok: false,
        error: makeError('EXEC_ERROR', 'Permission denied'), // Too generic
    };
}
```

## Error Messages

Write helpful error messages:

```typescript
// ✅ Good - Actionable message
makeError(
    'DENIED_COMMAND_ALLOWLIST',
    `Command '${cmd}' is not allowed. Add it to permissions.json allow_commands array.`
)

// ✅ Good - Shows what's wrong and how to fix
makeError(
    'MISSING_ARGUMENT',
    `Required argument 'text' is missing. Provide text when calling this tool.`
)

// ❌ Bad - Vague message
makeError('EXEC_ERROR', 'Error occurred')

// ❌ Bad - Technical jargon
makeError('EXEC_ERROR', 'EACCES: permission denied, open')
```

## Error Recovery

When possible, provide recovery suggestions:

```typescript
// ✅ Good - Suggests fix
if (!apiKey) {
    return {
        ok: false,
        error: makeError(
            'EXEC_ERROR',
            'No API key configured. Set GROQ_API_KEY environment variable or add to config.json',
            { suggestion: 'export GROQ_API_KEY=your-key' }
        ),
    };
}

// ❌ Bad - No guidance
if (!apiKey) {
    return {
        ok: false,
        error: makeError('EXEC_ERROR', 'No API key'),
    };
}
```

## Error Logging

Log errors appropriately:

```typescript
// ✅ Good - Log with context
if (verbose) {
    console.error(`[Error] ${error.code}: ${error.message}`);
    if (error.details) {
        console.error(`[Error] Details:`, error.details);
    }
}

// ❌ Bad - Log sensitive data
console.error(`[Error] API key: ${apiKey}`); // Never log secrets
```

## Exit Codes

Map error codes to exit codes:

```typescript
// In CLI/app layer
function exitCodeForError(error: ToolError | null): number {
    if (!error || !error.code) return 1;
    
    // Validation/permission errors = 2 (user error)
    if (
        error.code === 'VALIDATION_ERROR' ||
        error.code === 'MISSING_ARGUMENT' ||
        error.code === 'DENIED_*'
    ) {
        return 2;
    }
    
    // Execution errors = 1 (system error)
    return 1;
}
```

## Error Type Guards

Use type guards for error handling:

```typescript
// ✅ Good - Type-safe error checking
function isValidationError(error: ToolError): boolean {
    return error.code === 'VALIDATION_ERROR' ||
           error.code === 'MISSING_ARGUMENT' ||
           error.code === 'INVALID_ARGUMENT';
}

function isPermissionError(error: ToolError): boolean {
    return error.code.startsWith('DENIED_');
}

// Usage
if (result.error) {
    if (isPermissionError(result.error)) {
        // Handle permission error
    } else if (isValidationError(result.error)) {
        // Handle validation error
    }
}
```

## Error Patterns by Context

### Tool Handlers

```typescript
export function handleTool(args: Args, context: Context): ToolResult {
    // 1. Validate args
    const validation = validateArgs(args);
    if (!validation.ok) {
        return {
            ok: false,
            error: makeError('VALIDATION_ERROR', validation.message),
        };
    }
    
    // 2. Check permissions
    if (!hasPermission(args, context)) {
        return {
            ok: false,
            error: makeError('DENIED_*', '...'),
        };
    }
    
    // 3. Execute with error handling
    try {
        const result = execute(args);
        return { ok: true, result };
    } catch (err: any) {
        return {
            ok: false,
            error: makeError('EXEC_ERROR', err.message),
        };
    }
}
```

### Providers

```typescript
async function chat(request: ChatRequest): Promise<ChatResponse> {
    try {
        const response = await fetch(this.endpoint, options);
        
        if (!response.ok) {
            return {
                ok: false,
                error: `API error ${response.status}: ${await response.text()}`,
            };
        }
        
        return parseResponse(await response.json());
    } catch (err: any) {
        return {
            ok: false,
            error: `Network error: ${err.message}`,
        };
    }
}
```

## Error Checklist

When adding error handling:

- [ ] Use `makeError()` helper
- [ ] Include specific error code
- [ ] Provide helpful error message
- [ ] Include relevant details
- [ ] Never throw from tool handlers
- [ ] Log errors appropriately (no secrets)
- [ ] Map to appropriate exit codes
- [ ] Consider error recovery suggestions

## Common Mistakes

### ❌ Don't Do This

```typescript
// Throwing errors
throw new Error('Something went wrong');

// Generic error messages
makeError('EXEC_ERROR', 'Error')

// Logging secrets
console.error(`API key: ${apiKey}`);

// Losing error context
catch (err) {
    return { ok: false, error: makeError('EXEC_ERROR', 'Failed') };
}
```

### ✅ Do This Instead

```typescript
// Return structured errors
return { ok: false, error: makeError('EXEC_ERROR', 'Something went wrong') };

// Specific error messages
makeError('DENIED_PATH_ALLOWLIST', `Path '${path}' is not allowed`);

// Sanitize logs
console.error('[Error] Authentication failed');

// Preserve context
catch (err: any) {
    return {
        ok: false,
        error: makeError('EXEC_ERROR', `Failed: ${err.message}`, { context }),
    };
}
```

## Integration with Other Rules

- **Security Rule**: See `.cursor/rules/security.mdc` for permission error patterns
- **Validation Rule**: See `src/core/validation.ts` for validation error helpers
- **Tools Rule**: See `.cursor/rules/tools.mdc` for tool handler error patterns
