---
description: Agent definitions and role-based tool access patterns
globs: ["src/agents/**/*.ts"]
alwaysApply: false
---

# Agent Patterns

## Agent Interface

Agents define role-based access to tools:

```typescript
export interface Agent {
    name: string;           // Unique identifier
    description: string;    // Human-readable purpose
    systemPrompt: string;   // LLM system prompt for this agent
    tools: string[];        // Allowed tool names
}
```

## Built-in Agents

### System Agent (Root Access)
```typescript
export const SYSTEM: Agent = {
    name: 'System',
    description: 'Root agent with access to all tools',
    systemPrompt: 'You are a helpful assistant...',
    tools: ['*'],  // Special: all tools allowed
};
```

### Assistant Agent (Safe Tools)
```typescript
export const ASSISTANT: Agent = {
    name: 'Assistant',
    description: 'General-purpose assistant with safe tools',
    tools: [
        'remember', 'recall',
        'task_add', 'task_list', 'task_done',
        'reminder_add', 'reminder_list',
        'calendar_list', 'calendar_event_add',
        'calculate', 'get_time',
    ],
};
```

### Coder Agent (File Access)
```typescript
export const CODER: Agent = {
    name: 'Coder',
    description: 'Developer assistant with file operations',
    tools: [
        'read_file', 'write_file', 'list_files',
        'git_status', 'git_diff', 'git_log',
        'run_cmd',  // Sandboxed commands only
    ],
};
```

### Organizer Agent (Productivity)
```typescript
export const ORGANIZER: Agent = {
    name: 'Organizer',
    description: 'Productivity and organization tools',
    tools: [
        'task_add', 'task_list', 'task_done',
        'reminder_add', 'reminder_list',
        'calendar_list', 'calendar_event_add',
        'email_list', 'message_list',
        'contact_search',
    ],
};
```

## Agent Selection

Agents are selected via CLI or config:

```bash
# CLI flag
./cli.js --agent coder "read main.ts"

# In REPL
/agent coder
```

## Creating a New Agent

### 1. Define in `src/agents/index.ts`

```typescript
export const MY_AGENT: Agent = {
    name: 'MyAgent',
    description: 'Does specific things',
    systemPrompt: `You are a specialized assistant for X.
    
    Your capabilities:
    - Can do A
    - Can do B
    
    You cannot:
    - Access files
    - Run commands
    `,
    tools: ['tool_a', 'tool_b', 'tool_c'],
};

// Add to AGENTS map
export const AGENTS: Record<string, Agent> = {
    system: SYSTEM,
    assistant: ASSISTANT,
    coder: CODER,
    organizer: ORGANIZER,
    myagent: MY_AGENT,  // Add here
};
```

### 2. Agent Naming

- Names are lowercase in AGENTS map
- Use descriptive, role-based names
- Keep names short (used in CLI: `--agent coder`)

## System Prompt Guidelines

Effective system prompts:

```typescript
const systemPrompt = `You are a ${role} assistant.

## Your Capabilities
${tools.map(t => `- ${t}: ${toolDescriptions[t]}`).join('\n')}

## Guidelines
1. Be concise and direct
2. Use tools when appropriate
3. Ask for clarification if needed

## Constraints
- You can only use the tools listed above
- Do not attempt to access restricted resources
`;
```

## Agent Tool Enforcement

The Executor enforces agent tool restrictions:

```typescript
// In Executor.execute()
if (this.agent && this.agent.name !== 'System') {
    if (!this.agent.tools.includes(toolName)) {
        return {
            ok: false,
            error: makeError(DENIED_AGENT_TOOLSET, 
                `Agent '${this.agent.name}' cannot use tool '${toolName}'`),
        };
    }
}
```

## Delegation Between Agents

Agents can delegate to other agents:

```typescript
// Delegation tools
'delegate_to_coder'      // Hand off to Coder agent
'delegate_to_organizer'  // Hand off to Organizer agent
'delegate_to_assistant'  // Hand off to Assistant agent
```

Delegation is useful when:
- Current agent lacks a needed tool
- Task is better suited to another agent's specialty
- Breaking complex tasks into subtasks

## Agent Permissions vs Tool Permissions

Two layers of access control:

```
1. Agent Layer (tools field)
   → Agent MUST have tool in its tools array

2. Global Layer (permissions.json)
   → Tool MUST NOT be in deny_tools
   → Paths MUST be in allow_paths
   → Commands MUST be in allow_commands
```

Both layers must allow the operation for it to succeed.
