---
description: Git workflow and commit best practices
globs: ["**/*"]
alwaysApply: false
---

# Git Workflow & Best Practices

## Agent Commit Policy

**The agent SHOULD commit changes automatically** when:
- ✅ Code changes are complete and tested
- ✅ All preflight checks pass
- ✅ Changes follow project conventions
- ✅ Commit message follows conventional commit format

**The agent SHOULD NOT commit** when:
- ❌ User explicitly asks not to commit
- ❌ Changes are incomplete or experimental
- ❌ Preflight checks fail
- ❌ User needs to review changes first

**Commit workflow for agent:**
1. Stage relevant files (`git add <files>`)
2. Run preflight checks (`npm run preflight`)
3. If checks pass, commit with conventional message
4. If checks fail, report errors and do not commit

## Automatic Git Hooks

### Pre-Commit Hook (Runs Automatically)

**Pre-commit hook runs automatically** when you run `git commit`:

1. ✅ Cleanup generated files (`npm run cleanup`)
2. ✅ Auto-fix formatting/linting (`npm run fix`)
3. ✅ Check formatting (`npm run format:check`)
4. ✅ Check linting (`npm run lint`)
5. ✅ Type check (`npm run typecheck`)

**If any check fails**, the commit is blocked and you'll see what needs to be fixed.

### Pre-Push Hook (Runs Automatically)

**Pre-push hook runs automatically** when you run `git push`:

- ✅ Full preflight checks (`npm run preflight`)
  - Build
  - Leak check
  - Smoke test

**If checks fail**, the push is blocked.

### Manual Checks (If Needed)

If hooks are disabled or you want to run manually:

```bash
npm run preflight
```

## Auto-Fix Formatting & Linting

**Quick fix command** (runs lint:fix + format):

```bash
npm run fix
```

This automatically:
- Fixes ESLint errors (where possible)
- Formats all TypeScript files with Prettier

**Individual commands**:
```bash
npm run lint:fix    # Fix ESLint issues
npm run format      # Format with Prettier
```

## Commit Message Format

Use conventional commits:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Formatting, missing semicolons, etc.
- `refactor`: Code refactoring
- `test`: Adding/updating tests
- `chore`: Maintenance tasks

**Examples**:
```
feat(tools): add generate tests command
fix(router): handle empty query strings
docs: update testing strategy guide
test(executor): add permission tests
```

## What NOT to Commit

### ❌ Never Commit

- Generated test files (`*test_tool*.ts`, `*e2e_test*.ts`)
- Build artifacts (`dist/`)
- Test artifacts (`.test-results/`, `coverage/`)
- Runtime data (`.assistant-data/`, `*.jsonl`)
- Node modules (`node_modules/`)
- IDE files (`.idea/`, `.vscode/settings.json.bak`)
- OS files (`.DS_Store`, `Thumbs.db`)
- Environment files (`.env`, `.env.local`)
- Logs (`*.log`)

### ✅ Always Commit

- Source code (`src/**/*.ts`)
- Configuration files (`package.json`, `tsconfig.json`)
- Documentation (`docs/**/*.md`, `README.md`)
- Cursor rules (`.cursor/rules/**/*.mdc`)
- Git config (`.gitignore`, `.gitattributes`)
- Scripts (`scripts/**/*.sh`)

## Generated Files

### Test Generation Files

Files generated by `assistant generate tests` should be:
- **Reviewed** before committing
- **Manually edited** if needed
- **Committed** if they're part of the test suite

**Pattern**: `*_tools.test.ts` (generated tests)

**Exception**: Temporary test files like `test_tool*.ts` should be cleaned up.

### Code Generation Files

Files generated by `assistant generate tool` should be:
- **Reviewed** before committing
- **Manually edited** to implement logic
- **Committed** once implemented

## Git Workflow

### 1. Check Status

```bash
git status
```

### 2. Review Changes

```bash
# See what changed
git diff

# See staged changes
git diff --staged
```

### 3. Stage Files

```bash
# Stage specific files
git add src/tools/my_tool.ts

# Stage all changes (be careful!)
git add -A

# Stage only modified files (not new untracked)
git add -u
```

### 4. Run Preflight

```bash
npm run preflight
```

### 5. Commit

```bash
git commit -m "feat(tools): add new tool"
```

## Cleanup Before Committing

### Remove Generated Test Files

```bash
# Remove temporary test generation files
rm -f src/tools/test_tool*.ts
rm -f src/tools/e2e_test*.ts
rm -f src/tools/TestTool*.ts
```

### Clean Build Artifacts

```bash
npm run clean
```

## Branch Strategy: GitHub Flow

**Strategy**: GitHub Flow (simple, fast, automated)

**Why**: Perfect for solo/small teams, works with semantic-release, fast iteration

### Branch Types

#### Protected: `main`

- **Purpose**: Production-ready code, always deployable
- **Protection**: Requires PR + review, CI must pass
- **Releases**: Automated via semantic-release
- **Direct commits**: Not allowed

#### Feature: `feature/<name>`

- **Purpose**: New features
- **Naming**: `feature/add-test-generation`, `feature/improve-routing`
- **Lifecycle**: Create → Develop → PR → Merge → Delete
- **Timeline**: 1-5 days typically

#### Fix: `fix/<name>`

- **Purpose**: Bug fixes
- **Naming**: `fix/router-empty-query`, `fix/memory-leak`
- **Lifecycle**: Same as feature branches

#### Docs: `docs/<name>`

- **Purpose**: Documentation updates
- **Naming**: `docs/update-git-workflow`
- **CI**: Lighter checks (format, lint)

#### Hotfix: `hotfix/<name>`

- **Purpose**: Critical production fixes (use sparingly)
- **Naming**: `hotfix/security-patch`
- **When**: Critical security/issues only

### Branch Naming Rules

**Format**: `<type>/<short-description>`

**Rules**:
- ✅ Lowercase
- ✅ Hyphens for multi-word
- ✅ Descriptive but concise (3-5 words)
- ❌ No spaces, underscores, or special chars

**Examples**:
- ✅ `feature/add-test-generation`
- ✅ `fix/router-empty-query`
- ❌ `Feature/NewTool` (uppercase)
- ❌ `fix-bug` (no type prefix)

### Standard Workflow

```bash
# 1. Create from main
git checkout main
git pull origin main
git checkout -b feature/my-feature

# 2. Develop (commit frequently)
git add .
git commit -m "feat: implement feature"

# 3. Keep updated
git fetch origin
git rebase origin/main  # or merge

# 4. Push and create PR
git push origin feature/my-feature
# Create PR on GitHub

# 5. After merge, cleanup
git checkout main
git pull
git branch -d feature/my-feature
```

### Merge Strategy

**Recommended**: Squash and Merge
- Clean linear history
- One commit per feature
- Easy to revert

**Alternative**: Rebase and Merge
- Preserves individual commits
- Good for small changes

**Avoid**: Merge Commit
- Clutters history

### CI/CD Integration

- **All PRs**: Format, lint, type check, build, tests
- **Main branch**: Full suite + semantic-release
- **Releases**: Automated from `main` via semantic-release

### Best Practices

**✅ Do**:
- Start from latest `main`
- Keep branches small (< 500 lines)
- Commit frequently
- Update with `main` regularly
- Delete after merge

**❌ Don't**:
- Commit directly to `main`
- Create branches from feature branches
- Let branches get stale (> 1 week)
- Use generic names
- Force push to shared branches

**See**: `docs/BRANCHING_STRATEGY.md` for complete guide

## Pull Request Checklist

Before opening a PR:

- [ ] All tests pass (`npm test`)
- [ ] Preflight checks pass (`npm run preflight`)
- [ ] Code is formatted (`npm run format:check`)
- [ ] No lint errors (`npm run lint`)
- [ ] Documentation updated (if needed)
- [ ] Commit messages follow convention
- [ ] Generated files reviewed/cleaned up

## Common Git Commands

```bash
# Check what files are untracked/modified
git status

# See detailed diff
git diff

# Stage all changes
git add -A

# Unstage a file
git reset HEAD <file>

# Discard changes to a file
git checkout -- <file>

# See commit history
git log --oneline

# Create a new branch
git checkout -b feature/my-feature

# Switch branches
git checkout main

# Merge branch
git merge feature/my-feature
```

## Integration with Other Rules

- **Code Review**: See `.cursor/rules/code_review.mdc` for review patterns
- **Testing**: See `.cursor/rules/testing.mdc` for test commit patterns
- **Documentation**: See `documentation.mdc` for doc commit patterns
