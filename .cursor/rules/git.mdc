---
description: Git workflow and commit best practices
globs: ["**/*"]
alwaysApply: true
---

# Git Workflow & Best Practices

## ⚠️ CRITICAL: Auto-Commit Policy

**The agent MUST commit changes automatically** when:
- ✅ Code changes are complete and tested
- ✅ All preflight checks pass
- ✅ Changes follow project conventions
- ✅ Commit message follows conventional commit format

**This is NOT optional.** After completing any code changes, you MUST:
1. Stage relevant files automatically
2. Run preflight checks automatically
3. Commit automatically if checks pass
4. Report what was committed

**The agent MUST NOT commit** when:
- ❌ User explicitly asks not to commit
- ❌ Changes are incomplete or experimental
- ❌ Preflight checks fail
- ❌ User needs to review changes first

## Required Commit Workflow

**After completing ANY code changes, you MUST follow this workflow:**

```bash
# Step 1: Stage files (automatic)
git add <modified-files>

# Step 2: Run preflight (automatic)
npm run preflight

# Step 3: Commit if checks pass (automatic)
git commit -m "<type>(<scope>): <subject>"

# Step 4: Report what was committed
```

**Do NOT wait for user to ask.** Commit automatically as part of completing the task.

### Examples of Correct Behavior

**✅ CORRECT:**
```
User: "/fix_todos"
Agent: 
  1. Fixes all TODOs
  2. Stages files: git add src/core/executor.ts src/llm/index.ts
  3. Runs preflight: npm run preflight
  4. Commits: git commit -m "refactor: convert TODO comments to documentation"
  5. Reports: "Fixed all TODOs and committed changes"
```

**❌ WRONG:**
```
User: "/fix_todos"
Agent:
  1. Fixes all TODOs
  2. Reports: "Fixed all TODOs" (waits for user to ask about commit)
```

### Workflow Checklist

Before completing any task that modifies code:
- [ ] Changes are complete
- [ ] Files are staged automatically
- [ ] Preflight checks run automatically
- [ ] Commit created automatically (if checks pass)
- [ ] Commit hash and message reported to user

## Automatic Git Hooks

### Pre-Commit Hook (Runs Automatically)

**Pre-commit hook runs automatically** when you run `git commit`:

1. ✅ Cleanup generated files (`npm run cleanup`)
2. ✅ Auto-fix formatting/linting (`npm run fix`)
3. ✅ Check formatting (`npm run format:check`)
4. ✅ Check linting (`npm run lint`)
5. ✅ Type check (`npm run typecheck`)

**If any check fails**, the commit is blocked and you'll see what needs to be fixed.

### Pre-Push Hook (Runs Automatically)

**Pre-push hook runs automatically** when you run `git push`:

- ✅ Full preflight checks (`npm run preflight`)
  - Build
  - Leak check
  - Smoke test

**If checks fail**, the push is blocked.

### Manual Checks (If Needed)

If hooks are disabled or you want to run manually:

```bash
npm run preflight
```

## Auto-Fix Formatting & Linting

**Quick fix command** (runs lint:fix + format):

```bash
npm run fix
```

This automatically:
- Fixes ESLint errors (where possible)
- Formats all TypeScript files with Prettier

**Individual commands**:
```bash
npm run lint:fix    # Fix ESLint issues
npm run format      # Format with Prettier
```

## Commit Message Format

Use conventional commits:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Formatting, missing semicolons, etc.
- `refactor`: Code refactoring
- `test`: Adding/updating tests
- `chore`: Maintenance tasks

**Examples**:
```
feat(tools): add generate tests command
fix(router): handle empty query strings
docs: update testing strategy guide
test(executor): add permission tests
```

## What NOT to Commit

### ❌ Never Commit

- Generated test files (`*test_tool*.ts`, `*e2e_test*.ts`)
- Build artifacts (`dist/`)
- Test artifacts (`.test-results/`, `coverage/`)
- Runtime data (`.assistant-data/`, `*.jsonl`)
- Node modules (`node_modules/`)
- IDE files (`.idea/`, `.vscode/settings.json.bak`)
- OS files (`.DS_Store`, `Thumbs.db`)
- Environment files (`.env`, `.env.local`)
- Logs (`*.log`)

### ✅ Always Commit

- Source code (`src/**/*.ts`)
- Configuration files (`package.json`, `tsconfig.json`)
- Documentation (`docs/**/*.md`, `README.md`)
- Cursor rules (`.cursor/rules/**/*.mdc`)
- Git config (`.gitignore`, `.gitattributes`)
- Scripts (`scripts/**/*.sh`)

## Generated Files

### Test Generation Files

Files generated by `assistant generate tests` should be:
- **Reviewed** before committing
- **Manually edited** if needed
- **Committed** if they're part of the test suite

**Pattern**: `*_tools.test.ts` (generated tests)

**Exception**: Temporary test files like `test_tool*.ts` should be cleaned up.

### Code Generation Files

Files generated by `assistant generate tool` should be:
- **Reviewed** before committing
- **Manually edited** to implement logic
- **Committed** once implemented

## Git Workflow

### 1. Check Status

```bash
git status
```

### 2. Review Changes

```bash
# See what changed
git diff

# See staged changes
git diff --staged
```

### 3. Stage Files

```bash
# Stage specific files
git add src/tools/my_tool.ts

# Stage all changes (be careful!)
git add -A

# Stage only modified files (not new untracked)
git add -u
```

### 4. Run Preflight

```bash
npm run preflight
```

### 5. Commit

```bash
git commit -m "feat(tools): add new tool"
```

## Cleanup Before Committing

### Remove Generated Test Files

```bash
# Remove temporary test generation files
rm -f src/tools/test_tool*.ts
rm -f src/tools/e2e_test*.ts
rm -f src/tools/TestTool*.ts
```

### Clean Build Artifacts

```bash
npm run clean
```

## Branch Strategy: Direct Commits to Main (Solo-Friendly)

**Strategy**: Direct commits to `main` with automated safeguards

**Why**: Fast iteration for solo development, works with semantic-release, pre-commit hooks provide safety

### Branch Types

#### Primary: `main`

- **Purpose**: Production-ready code, always deployable
- **Direct commits**: ✅ **Allowed** (with safeguards)
- **Safeguards**: 
  - Pre-commit hooks (format, lint, typecheck)
  - Pre-push hooks (preflight: build, leak check, smoke test)
  - CI runs on every push
- **Releases**: Automated via semantic-release
- **Best for**: Solo development, small-medium changes (< 200 lines)

#### Optional: Feature Branches `feature/<name>`

- **Purpose**: Large features or experimental work
- **When to use**: 
  - Changes > 200 lines
  - Breaking changes
  - Complex refactors
  - Experimental features that might be abandoned
- **Naming**: `feature/add-test-generation`, `feature/improve-routing`
- **Lifecycle**: Create → Develop → Merge to main (or delete if abandoned)
- **Timeline**: 1-5 days typically

#### Optional: Fix Branches `fix/<name>`

- **Purpose**: Complex bug fixes that need isolation
- **When to use**: Multi-file fixes, fixes requiring multiple commits
- **Naming**: `fix/router-empty-query`, `fix/memory-leak`
- **Lifecycle**: Same as feature branches

#### Optional: Docs Branches `docs/<name>`

- **Purpose**: Large documentation updates
- **When to use**: Major doc rewrites, multiple doc files
- **Naming**: `docs/update-git-workflow`
- **Note**: Most doc changes can go directly to main

### Branch Naming Rules

**Format**: `<type>/<short-description>`

**Rules**:
- ✅ Lowercase
- ✅ Hyphens for multi-word
- ✅ Descriptive but concise (3-5 words)
- ❌ No spaces, underscores, or special chars

**Examples**:
- ✅ `feature/add-test-generation`
- ✅ `fix/router-empty-query`
- ❌ `Feature/NewTool` (uppercase)
- ❌ `fix-bug` (no type prefix)

### Standard Workflow: Direct Commits (Default)

```bash
# 1. Make changes
# ... edit files ...

# 2. Stage and commit (pre-commit hooks run automatically)
git add <files>
git commit -m "feat(tools): add new tool"

# 3. Push (pre-push hooks run automatically)
git push origin main

# That's it! Fast and simple.
```

### Optional Workflow: Feature Branches (For Large Changes)

```bash
# 1. Create feature branch
git checkout -b feature/my-feature

# 2. Develop (commit frequently)
git add .
git commit -m "feat: implement feature"

# 3. When ready, merge to main
git checkout main
git merge feature/my-feature
# OR squash: git merge --squash feature/my-feature

# 4. Cleanup
git branch -d feature/my-feature
git push origin main
```

### Merge Strategy

**Recommended**: Squash and Merge
- Clean linear history
- One commit per feature
- Easy to revert

**Alternative**: Rebase and Merge
- Preserves individual commits
- Good for small changes

**Avoid**: Merge Commit
- Clutters history

### CI/CD Integration

- **Main branch**: Full suite (format, lint, type check, build, tests) + semantic-release
- **Feature branches**: Same checks (if you use them)
- **Releases**: Automated from `main` via semantic-release on every push

### Best Practices

**✅ Do**:
- Commit directly to `main` for most changes
- Run `npm run preflight` before pushing (or rely on pre-push hook)
- Commit frequently with clear messages
- Use feature branches for large changes (> 200 lines)
- Keep commits focused and atomic
- Use conventional commit format

**❌ Don't**:
- Push without running preflight (or disable pre-push hook)
- Commit broken code (hooks should catch this)
- Create feature branches for small changes
- Force push to `main` (unless absolutely necessary)
- Commit without meaningful commit messages

**See**: `docs/BRANCHING_STRATEGY.md` for complete guide

## Pre-Commit Checklist

Before committing to `main`:

- [ ] Changes are complete and tested
- [ ] Preflight checks pass (`npm run preflight`) - runs automatically via hooks
- [ ] Code is formatted (auto-fixed by pre-commit hook)
- [ ] No lint errors (auto-fixed by pre-commit hook)
- [ ] Type check passes (checked by pre-commit hook)
- [ ] Commit message follows conventional format
- [ ] Generated files reviewed/cleaned up

**Note**: Pre-commit and pre-push hooks handle most of this automatically!

## Common Git Commands

```bash
# Check what files are untracked/modified
git status

# See detailed diff
git diff

# Stage all changes
git add -A

# Unstage a file
git reset HEAD <file>

# Discard changes to a file
git checkout -- <file>

# See commit history
git log --oneline

# Create a new branch
git checkout -b feature/my-feature

# Switch branches
git checkout main

# Merge branch
git merge feature/my-feature
```

## Integration with Other Rules

- **Code Review**: See `.cursor/rules/code_review.mdc` for review patterns
- **Testing**: See `.cursor/rules/testing.mdc` for test commit patterns
- **Documentation**: See `documentation.mdc` for doc commit patterns
