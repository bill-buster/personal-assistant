---
description: Test execution policy - when to run tests and how to avoid redundant runs
globs: ["**/*"]
alwaysApply: true
---

# Test Execution Policy

## ⚠️ BEFORE Running Tests - Decision Tree

**Always check state first, never assume tests need running.**

### Step 1: Check Change Type

```bash
# Check what files changed
git diff --name-only HEAD
```

**If change is docs-only** (matches `docs/**`, `README.md`, `CHANGELOG.md`, `.cursor/**`, `*.md`):
→ **DO NOT run tests.** Skip to end.

### Step 2: Check Existing Test Results

```bash
# Read latest test summary
cat .test-results/latest.json 2>/dev/null
```

**If `.test-results/latest.json` exists AND:**
- `passed: true`
- `timestamp` is less than 1 hour ago
- `git diff --name-only` shows NO changes in `src/**` or `**/*.test.*`

→ **SKIP tests.** The test runner's cache (`TestCache.shouldSkipTest()`) will handle per-test skipping automatically.

### Step 3: Run Tests (Only If Needed)

**If tests are needed:**

1. **Prefer targeted runs:**
   ```bash
   # If you changed src/tools/memory_tools.ts, run only:
   npm run build && npm run test:single memory_store
   ```

2. **Otherwise run full suite:**
   ```bash
   npm test
   ```
   The test runner will automatically skip unchanged tests via `TestCache.shouldSkipTest()`.

### Step 4: After Test Run

**Never run `npm test` more than once per task** unless:
- A test failed (then rerun only the failed test if possible)
- You made additional code changes after the first run

**After a failure:**
- Rerun only the failed test: `npm run test:single <test-name>`
- Do NOT rerun the full suite unless multiple tests failed

## How Test Caching Works

The test runner (`src/run_tests.ts`) uses `TestCache` (`src/core/test_cache.ts`) which:

1. **Hashes test files** and related source files (stored in `.test-results/checksums.json`)
2. **Checks for recent passes** in `.test-results/results.jsonl` (within 1 hour default)
3. **Automatically skips** unchanged tests that passed recently

**You don't need to write persistence code in test files.** The runner handles all caching automatically.

## Test Result Files

The test runner automatically creates:

- `.test-results/latest.json` - Summary of last full run (written by `testCache.updateSummary()`)
- `.test-results/results.jsonl` - Append-only log of individual test results
- `.test-results/checksums.json` - File hashes for change detection

**Do not manually write to these files.** The test runner manages them.

## Anti-Thrash Rules

**DO NOT run tests if:**
- Only documentation files changed
- `.test-results/latest.json` shows recent pass with no source changes
- Less than 1 hour since last successful run with no changes

**DO run tests if:**
- You modified source code in `src/**`
- You modified test files (`**/*.test.ts`)
- No recent results exist
- Previous run failed

## Quick Reference

```bash
# Check if tests needed
cat .test-results/latest.json

# Check what changed
git diff --name-only HEAD

# Run single test (preferred)
npm run test:single <test-name>

# Run full suite (only if needed)
npm test
```
