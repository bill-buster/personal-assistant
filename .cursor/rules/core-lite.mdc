---
description: Core security invariants, error codes, and essential conventions (lightweight, always applied)
globs: ["**/*.ts"]
alwaysApply: true
---

# Personal Assistant - Core Conventions (Lite)

## Project Overview

This is a local-first CLI assistant that routes natural language to tools with optional LLM fallback. It uses a multi-stage routing strategy: Regex → Heuristic → Parsers → LLM.

## Technology Stack

- **Runtime**: Node.js 18+ with TypeScript (ES2020 target, CommonJS modules)
- **Validation**: Zod v4 for runtime validation at all boundaries
- **Build**: tsc with strict mode enabled
- **Testing**: Custom test runner with colocated test files (`*.test.ts`)

## Architecture Layers

```
src/
├── app/         # Entry points: CLI, REPL, router, web server
├── core/        # Config, executor, types, validation, tool registry
├── agents/      # Agent definitions with role-based tool access
├── parsers/     # Heuristic, task, memory parsers (NLP patterns)
├── providers/   # LLM provider adapters (Groq, OpenRouter)
├── llm/         # ChatModel interface (provider-agnostic)
├── embeddings/  # EmbeddingModel interface
├── storage/     # JSONL persistence, memory store
├── runtime/     # Composition root, bootstrap
└── tools/       # Tool implementations
```

## Import Conventions

```typescript
// 1. Node built-ins with 'node:' prefix
import * as fs from 'node:fs';
import * as path from 'node:path';
import { spawnSync } from 'node:child_process';

// 2. External packages
import { z } from 'zod';

// 3. Internal imports (relative paths only, no @repo/* aliases)
import { ExecutorContext, ToolResult } from '../core/types';
import { makeError, makeDebug } from '../core';
```

## Security Invariants (CRITICAL)

### Fail-Closed Security Model

All security checks fail closed (deny by default):
- No agent = only safe tools allowed
- Path validation required for all file operations
- Command allowlist enforced
- Never execute user input directly

### Path Validation

Always use `context.paths.resolveAllowed()` for file paths. Never construct paths from user input without validation.

### Error Handling

**Never throw** - always return structured errors:
```typescript
// ✅ Good
return { ok: false, error: makeError('EXEC_ERROR', err.message) };

// ❌ Bad
throw new Error('Something went wrong');
```

## Error Codes

Use `makeError()` helper with specific error codes:
- `VALIDATION_ERROR` - Input validation failed
- `MISSING_ARGUMENT` - Required argument missing
- `INVALID_ARGUMENT` - Invalid argument value
- `EXEC_ERROR` - Execution failure
- `DENIED_PATH_ALLOWLIST` - Path not allowed
- `DENIED_COMMAND_ALLOWLIST` - Command not allowed
- `DENIED_AGENT_TOOLSET` - Tool not available to agent
- `CONFIRMATION_REQUIRED` - Confirmation needed

## Key Conventions

### Zod Validation

Always validate with Zod schemas at boundaries:
```typescript
const result = schema.safeParse(data);
if (!result.success) {
    return { ok: false, error: makeError('VALIDATION_ERROR', result.error.issues[0].message) };
}
const validated = result.data;
```

### ToolResult Pattern

All tools return `ToolResult`:
```typescript
export type ToolResult =
    | { ok: true; result: any; _debug?: DebugInfo | null }
    | { ok: false; error: ToolError; _debug?: DebugInfo | null };
```

### Type Inference from Zod

Always derive types from Zod schemas:
```typescript
export const MySchema = z.object({ /* ... */ });
export type MyType = z.infer<typeof MySchema>;  // ✅ Preferred
```

## Logging (CRITICAL)

**Debug logs must go to stderr, not stdout.** stdout is reserved for actual command output (especially JSON).

```typescript
// ✅ Good: stderr for debug
console.error('[Debug] Processing:', input);

// ✅ Good: stdout only for actual output
if (outputFormat === 'json') {
    console.log(JSON.stringify(result));
}

// ❌ Bad: debug logs to stdout (breaks JSON parsing)
console.log('[Debug] Processing:', input);
```

## Git Workflow (CRITICAL)

**After completing ANY code changes, you MUST commit automatically:**
1. Stage files: `git add <modified-files>`
2. Run preflight: `npm run preflight`
3. Commit if checks pass: `git commit -m "<type>(<scope>): <subject>"`
4. Report what was committed
5. Automatically run review_pr command to review the committed changes

**Do NOT wait for user to ask.** This is REQUIRED, not optional.

See `.cursor/rules/git.mdc` for complete workflow details.

## Related Rules

- **Git Workflow**: See `.cursor/rules/git.mdc` for commit policy and workflow (REQUIRED)
- **Error Handling**: See `.cursor/rules/errors.mdc` for error patterns and error codes
- **Security**: See `.cursor/rules/security.mdc` for security patterns
- **Full Conventions**: See `.cursor/rules/core-full.mdc` for detailed examples and patterns
